<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legacy PLC Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 2px solid #4CAF50;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .connection-panel {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #666;
        }
        
        .connection-panel label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        
        .connection-panel input, .connection-panel select {
            background: #333;
            color: #fff;
            border: 1px solid #666;
            padding: 8px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .connection-panel button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .connection-panel button:hover {
            background: #45a049;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .status-connected { background: #4CAF50; }
        .status-disconnected { background: #f44336; }
        .status-connecting { background: #ff9800; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #666;
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .panel h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 1px solid #666;
            padding-bottom: 8px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .metric-label {
            color: #ccc;
        }
        
        .metric-value {
            font-weight: bold;
            color: #fff;
        }
        
        .led {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-left: 8px;
            border: 2px solid #333;
        }
        
        .led-on { background: #4CAF50; box-shadow: 0 0 10px #4CAF50; }
        .led-off { background: #666; }
        .led-alarm { background: #f44336; box-shadow: 0 0 10px #f44336; }
        
        .chart-container {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            height: 200px;
            position: relative;
            overflow: hidden;
        }
        
        .chart {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .log-panel {
            grid-column: 1 / -1;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            padding: 2px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-timestamp {
            color: #888;
        }
        
        .log-level-info { color: #4CAF50; }
        .log-level-warning { color: #ff9800; }
        .log-level-error { color: #f44336; }
        
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>? Legacy PLC Dashboard</h1>
            <p>Schneider/Modicon TSX Premium Simulator (circa 2004)</p>
        </div>
        
        <div class="connection-panel">
            <label>Target:</label>
            <select id="targetType">
                <option value="pi">Physical Pi</option>
                <option value="vm">Virtual Machine</option>
                <option value="custom">Custom</option>
            </select>
            
            <label>Host:</label>
            <input type="text" id="hostInput" placeholder="pi-legacy or IP address" value="pi-legacy">
            
            <label>Port:</label>
            <input type="number" id="portInput" value="8080" style="width: 80px;">
            
            <button onclick="connect()">Connect</button>
            <span class="status-indicator status-disconnected" id="statusIndicator"></span>
            <span id="statusText">Disconnected</span>
        </div>
        
        <div id="errorPanel" class="error-message" style="display: none;"></div>
        
        <div class="dashboard-grid">
            <div class="panel">
                <h3>? System Status</h3>
                <div class="metric">
                    <span class="metric-label">Status:</span>
                    <span class="metric-value" id="systemStatus">Unknown</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime (Cycles):</span>
                    <span class="metric-value" id="uptimeCycles">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Scan Rate:</span>
                    <span class="metric-value" id="scanRate">100ms</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Error Codes:</span>
                    <span class="metric-value" id="errorCodes">0x00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Mode:</span>
                    <span class="metric-value" id="operationMode">Unknown</span>
                </div>
            </div>
            
            <div class="panel">
                <h3>?? Process Inputs</h3>
                <div class="metric">
                    <span class="metric-label">Temperature (Raw):</span>
                    <span class="metric-value" id="tempRaw">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pressure (Raw):</span>
                    <span class="metric-value" id="pressureRaw">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Cycle Input:</span>
                    <span class="metric-value" id="cycleInput">0</span>
                    <span class="led led-off" id="cycleInputLed"></span>
                </div>
                <div class="metric">
                    <span class="metric-label">Run Enable:</span>
                    <span class="metric-value" id="runEnable">0</span>
                    <span class="led led-off" id="runEnableLed"></span>
                </div>
            </div>
            
            <div class="panel">
                <h3>? Control Outputs</h3>
                <div class="metric">
                    <span class="metric-label">Heater Command:</span>
                    <span class="metric-value" id="heaterCommand">0</span>
                    <span class="led led-off" id="heaterLed"></span>
                </div>
                <div class="metric">
                    <span class="metric-label">High Temp Alarm:</span>
                    <span class="metric-value" id="highTempAlarm">0</span>
                    <span class="led led-off" id="alarmLed"></span>
                </div>
                <div class="metric">
                    <span class="metric-label">Heartbeat LED:</span>
                    <span class="metric-value" id="heartbeat">0</span>
                    <span class="led led-off" id="heartbeatLed"></span>
                </div>
            </div>
            
            <div class="panel">
                <h3>? Configuration</h3>
                <div class="metric">
                    <span class="metric-label">Temp Setpoint:</span>
                    <span class="metric-value" id="tempSetpoint">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Alarm Threshold:</span>
                    <span class="metric-value" id="alarmThreshold">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Current Temp:</span>
                    <span class="metric-value" id="currentTemp">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Heater Status:</span>
                    <span class="metric-value" id="heaterStatus">0</span>
                </div>
            </div>
            
            <div class="panel">
                <h3>? Network Interfaces</h3>
                <div class="metric">
                    <span class="metric-label">Control Protocol:</span>
                    <span class="metric-value" id="controlEndpoint">Unknown</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Management:</span>
                    <span class="metric-value" id="mgmtEndpoint">Unknown</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Control VLAN:</span>
                    <span class="metric-value" id="controlVlan">Unknown</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Management VLAN:</span>
                    <span class="metric-value" id="mgmtVlan">Unknown</span>
                </div>
            </div>
            
            <div class="panel">
                <h3>? Temperature Trend</h3>
                <div class="chart-container">
                    <div class="chart" id="tempChart">
                        <canvas id="tempCanvas" width="280" height="170"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="panel log-panel">
                <h3>? Activity Log</h3>
                <div id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[System]</span>
                        <span class="log-level-info">Dashboard loaded - Ready to connect</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval = null;
        let tempHistory = [];
        let maxDataPoints = 50;
        
        // Connection management
        function connect() {
            const targetType = document.getElementById('targetType').value;
            const host = document.getElementById('hostInput').value;
            let port = document.getElementById('portInput').value;
            
            // Auto-configure based on target type
            if (targetType === 'pi') {
                port = 8080;
                document.getElementById('portInput').value = 8080;
            } else if (targetType === 'vm') {
                port = 8901;
                document.getElementById('portInput').value = 8901;
                if (host === 'pi-legacy') {
                    document.getElementById('hostInput').value = 'localhost';
                }
            }
            
            setStatus('connecting', 'Connecting...');
            logMessage('info', `Attempting connection to ${host}:${port}`);
            
            // Clear any existing interval
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // Start polling
            updateInterval = setInterval(() => fetchData(host, port), 2000);
            fetchData(host, port); // Initial fetch
        }
        
        async function fetchData(host, port) {
            try {
                let apiUrl;
                
                // Check if we're accessing the dashboard from the same host as the API
                if (window.location.hostname === host) {
                    // Use nginx proxy to avoid CORS issues
                    apiUrl = `/api/`;
                } else {
                    // Direct API access (may have CORS issues)
                    apiUrl = `http://${host}:${port}/`;
                }
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    mode: 'cors',
                    timeout: 5000
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                updateDashboard(data);
                setStatus('connected', 'Connected');
                hideError();
                
            } catch (error) {
                setStatus('disconnected', 'Connection Failed');
                let errorMsg = `Connection error: ${error.message}<br><small>`;
                
                if (window.location.hostname === host) {
                    errorMsg += `? Dashboard and API on same host - using proxy<br>`;
                    errorMsg += `? Check if PLC service is running: curl http://${host}:${port}/<br>`;
                    errorMsg += `? Verify nginx proxy configuration`;
                } else {
                    errorMsg += `? Check if PLC service is running<br>`;
                    errorMsg += `? Verify host/port settings<br>`;
                    errorMsg += `? CORS may be blocking cross-origin requests<br>`;
                    errorMsg += `? Try accessing dashboard at http://${host}:8000 instead`;
                }
                
                errorMsg += `</small>`;
                showError(errorMsg);
                logMessage('error', `Connection failed: ${error.message}`);
                
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            }
        }
        
        function updateDashboard(data) {
            // System status
            document.getElementById('systemStatus').textContent = data.operational_status?.status || 'Unknown';
            document.getElementById('uptimeCycles').textContent = data.operational_status?.uptime_cycles || 0;
            document.getElementById('scanRate').textContent = `${data.operational_status?.scan_rate_ms || 100}ms`;
            document.getElementById('errorCodes').textContent = data.operational_status?.error_codes || '0x00';
            document.getElementById('operationMode').textContent = data.device_info?.mode || 'Unknown';
            
            // Process inputs
            const inputs = data.process_data?.inputs || {};
            document.getElementById('tempRaw').textContent = inputs.temperature_raw || 0;
            document.getElementById('pressureRaw').textContent = inputs.pressure_raw || 0;
            document.getElementById('cycleInput').textContent = inputs.cycle_input || 0;
            document.getElementById('runEnable').textContent = inputs.run_enable || 0;
            
            // Update input LEDs
            updateLED('cycleInputLed', inputs.cycle_input);
            updateLED('runEnableLed', inputs.run_enable);
            
            // Control outputs
            const outputs = data.process_data?.outputs || {};
            document.getElementById('heaterCommand').textContent = outputs.heater_command || 0;
            document.getElementById('highTempAlarm').textContent = outputs.high_temp_alarm || 0;
            document.getElementById('heartbeat').textContent = outputs.heartbeat_led || 0;
            
            // Update output LEDs
            updateLED('heaterLed', outputs.heater_command);
            updateLED('alarmLed', outputs.high_temp_alarm, 'alarm');
            updateLED('heartbeatLed', outputs.heartbeat_led);
            
            // Configuration registers
            const registers = data.process_data?.registers || {};
            document.getElementById('tempSetpoint').textContent = registers.temperature_setpoint || 0;
            document.getElementById('alarmThreshold').textContent = registers.alarm_threshold || 0;
            document.getElementById('currentTemp').textContent = registers.current_temperature || 0;
            document.getElementById('heaterStatus').textContent = registers.heater_status || 0;
            
            // Network interfaces
            const network = data.network_interfaces || {};
            const control = network.control_protocol || {};
            const mgmt = network.management_protocol || {};
            
            document.getElementById('controlEndpoint').textContent = control.endpoint || 'Unknown';
            document.getElementById('mgmtEndpoint').textContent = mgmt.endpoint || 'Unknown';
            document.getElementById('controlVlan').textContent = control.vlan || 'Unknown';
            document.getElementById('mgmtVlan').textContent = mgmt.vlan || 'Unknown';
            
            // Update temperature chart
            updateTempChart(inputs.temperature_raw || 0);
            
            // Log significant changes
            if (outputs.high_temp_alarm && outputs.high_temp_alarm > 0) {
                logMessage('warning', 'High temperature alarm active');
            }
            if (inputs.run_enable === 0) {
                logMessage('warning', 'Run enable is OFF');
            }
        }
        
        function updateLED(elementId, value, type = 'normal') {
            const led = document.getElementById(elementId);
            led.className = 'led';
            
            if (value > 0) {
                if (type === 'alarm') {
                    led.classList.add('led-alarm');
                } else {
                    led.classList.add('led-on');
                }
            } else {
                led.classList.add('led-off');
            }
        }
        
        function updateTempChart(temperature) {
            tempHistory.push(temperature);
            if (tempHistory.length > maxDataPoints) {
                tempHistory.shift();
            }
            
            const canvas = document.getElementById('tempCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (tempHistory.length < 2) return;
            
            // Calculate scale
            const margin = 20;
            const plotWidth = canvas.width - 2 * margin;
            const plotHeight = canvas.height - 2 * margin;
            
            const minTemp = Math.min(...tempHistory) - 10;
            const maxTemp = Math.max(...tempHistory) + 10;
            const tempRange = maxTemp - minTemp || 1;
            
            // Draw grid
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines
            for (let i = 0; i <= 4; i++) {
                const y = margin + (plotHeight * i / 4);
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(canvas.width - margin, y);
                ctx.stroke();
            }
            
            // Draw temperature line
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < tempHistory.length; i++) {
                const x = margin + (plotWidth * i / (maxDataPoints - 1));
                const y = canvas.height - margin - ((tempHistory[i] - minTemp) / tempRange * plotHeight);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Draw current value
            ctx.fillStyle = '#4CAF50';
            ctx.font = '12px Courier New';
            ctx.fillText(`${temperature}°`, 5, 15);
        }
        
        function setStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }
        
        function showError(message) {
            const errorPanel = document.getElementById('errorPanel');
            errorPanel.innerHTML = message;
            errorPanel.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorPanel').style.display = 'none';
        }
        
        function logMessage(level, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            
            // Keep only last 20 entries
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.firstChild);
            }
            
            // Scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Auto-configure based on current location
        window.onload = function() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('targetType').value = 'vm';
                document.getElementById('hostInput').value = 'localhost';
                document.getElementById('portInput').value = '8901';
            }
        };
        
        // Handle target type changes
        document.getElementById('targetType').addEventListener('change', function() {
            const targetType = this.value;
            if (targetType === 'pi') {
                document.getElementById('hostInput').value = 'pi-legacy';
                document.getElementById('portInput').value = '8080';
            } else if (targetType === 'vm') {
                document.getElementById('hostInput').value = 'localhost';
                document.getElementById('portInput').value = '8901';
            }
        });
    </script>
</body>
</html>
